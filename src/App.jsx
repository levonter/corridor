import{useState,useRef,useEffect,useCallback}from'react'
import'leaflet/dist/leaflet.css'
import'./styles/theme.css'
import{ICON_MAP,SEVERITY,BASE_LAYERS,SUDAN_EVENT,createEvent,computeStats,computeTypeCounts,buildSystemPrompt,renderEventToMap,BRIEF_ANALYSIS_PROMPT,eventToGeoJSON,eventToCSV,eventToReport,encodeShare,decodeShare,INC_TYPES,SEV_LEVELS,EVENT_TYPES,COPERNICUS_INSTANCE,buildOverpassQuery,localParseBrief,setGeoBias}from'./data/events.js'
import{t,LANGS}from'./data/i18n.js'
import SharedView from'./components/SharedView.jsx'
const ls=(k,fb)=>{try{const v=localStorage.getItem('cp_'+k);return v!==null?JSON.parse(v):fb}catch{return fb}}
const ss=(k,v)=>{try{localStorage.setItem('cp_'+k,JSON.stringify(v))}catch{}}
const dlF=(c,f,m='text/plain')=>{const b=new Blob([c],{type:m});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=f;a.click();URL.revokeObjectURL(u)}
function mkTile(Lf,id,th){const T={osm:()=>Lf.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}),dark:()=>Lf.tileLayer("https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png",{maxZoom:20}),darklabel:()=>Lf.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{maxZoom:20}),hot:()=>Lf.tileLayer("https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png",{maxZoom:19}),esri:()=>Lf.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:19}),topo:()=>Lf.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",{maxZoom:17})};if(id==='osm'&&th==='dark')return T.dark();return(T[id]||T.osm)()}
export default function App(){
const[shared,setShared]=useState(null);useEffect(()=>{const h=window.location.hash;if(h.startsWith('#/share/')){const d=decodeShare(h.slice(8));if(d)setShared(d)}},[]);if(shared)return<SharedView data={shared}/>
const[theme,setTheme]=useState(()=>ls('theme','dark')),[lang,setLang]=useState(()=>ls('lang','en')),[view,setView]=useState('map'),[panelOpen,setPanelOpen]=useState(()=>ls('po',true)),[fs,setFs]=useState(()=>ls('fs',13)),[showSettings,setShowSettings]=useState(false),[settingsTab,setSettingsTab]=useState('appearance'),[baseLayerId,setBaseLayerId]=useState(()=>ls('bl','darklabel')),[sentinel2,setSentinel2]=useState(false),[dataLayers,setDataLayers]=useState({incidents:true,access:true,risks:true,corridor:true}),[apiKey,setApiKey]=useState(()=>ls('ak','')),[aiModel,setAiModel]=useState(()=>ls('am','claude-sonnet-4-20250514')),[aiStatus,setAiStatus]=useState('unconfigured'),[aiProviders,setAiProviders]=useState(()=>ls('aip',[{id:'anthropic',name:'Claude',url:'https://api.anthropic.com/v1/messages',key:'',models:['claude-sonnet-4-20250514','claude-haiku-4-5-20251001'],active:true},{id:'openai',name:'ChatGPT',url:'https://api.openai.com/v1/chat/completions',key:'',models:['gpt-4o','gpt-4o-mini','o3-mini'],active:false},{id:'deepseek',name:'DeepSeek',url:'https://api.deepseek.com/chat/completions',key:'',models:['deepseek-chat','deepseek-reasoner'],active:false},{id:'google',name:'Gemini',url:'https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent',key:'',models:['gemini-2.0-flash','gemini-2.5-pro-exp-03-25'],active:false},{id:'xai',name:'Grok',url:'https://api.x.ai/v1/chat/completions',key:'',models:['grok-3-mini','grok-3'],active:false}])),[activeProvider,setActiveProvider]=useState(()=>ls('apv','anthropic')),[activeModel,setActiveModel]=useState(()=>ls('amd','claude-sonnet-4-20250514')),[mapAnims,setMapAnims]=useState(()=>ls('ma',true)),[events,setEvents]=useState(()=>ls('events',[SUDAN_EVENT])),[activeEventId,setActiveEventId]=useState(()=>ls('ae',SUDAN_EVENT.id)),[detailOpen,setDetailOpen]=useState(false),[detailTab,setDetailTab]=useState('ai'),[searchQuery,setSearchQuery]=useState(''),[chatMsgs,setChatMsgs]=useState({}),[chatHist,setChatHist]=useState({}),[inputVal,setInputVal]=useState(''),[busy,setBusy]=useState(false),[noteInput,setNoteInput]=useState(''),[briefInput,setBriefInput]=useState(''),[briefAnalyzing,setBriefAnalyzing]=useState(false),[showArchived,setShowArchived]=useState(false),[showShareModal,setShowShareModal]=useState(false),[shareUrl,setShareUrl]=useState(''),[sharePw,setSharePw]=useState(''),[sharePwOn,setSharePwOn]=useState(false),[showExportMenu,setShowExportMenu]=useState(false),[copyFb,setCopyFb]=useState(''),[showIncForm,setShowIncForm]=useState(false),[incForm,setIncForm]=useState({ti:'',d:'',tp:'displacement',s:'medium',ac:'',og:'',a:null,o:null,drawType:null,drawR:50}),[mapClickMode,setMapClickMode]=useState(false),[infraLayers,setInfraLayers]=useState({}),[infraLoading,setInfraLoading]=useState(''),[showAddMenu,setShowAddMenu]=useState(false),[editBriefId,setEditBriefId]=useState(null),[editBriefText,setEditBriefText]=useState(''),[editIncId,setEditIncId]=useState(null),[editInc,setEditInc]=useState(null)
const mcR=useRef(null),mR=useRef(null),LR=useRef(null),blR=useRef(null),snR=useRef(null),elR=useRef({}),ceR=useRef(null),stR=useRef(null),igR=useRef({}),cmR=useRef(null)
const _=k=>t(k,lang),ae=events.find(e=>e.id===activeEventId)||events[0],stats=computeStats(ae),typeCounts=computeTypeCounts(ae),fEvts=events.filter(e=>e.name.toLowerCase().includes(searchQuery.toLowerCase())||(e.brief||'').toLowerCase().includes(searchQuery.toLowerCase())),cMsgs=chatMsgs[activeEventId]||[{role:'a',text:_('aiWelcome')}],sInc=[...(ae?.incidents||[])].sort((a,b)=>a.dt.localeCompare(b.dt)),aBriefs=(ae?.briefs||[]).filter(b=>!b.archived),xBriefs=(ae?.briefs||[]).filter(b=>b.archived)
const inp={padding:'7px 8px',borderRadius:6,fontSize:'calc(var(--fs)*.72)',background:'var(--surface-input)',border:'1px solid var(--border-input)',color:'var(--text-primary)',fontFamily:'inherit',outline:'none',width:'100%'}
const svB=s=>({fontSize:'calc(var(--fs)*.52)',padding:'1px 5px',borderRadius:3,fontWeight:700,background:(SEVERITY[s]||SEVERITY.medium).bg,color:(SEVERITY[s]||SEVERITY.medium).color})
const layerOpts=theme==='dark'?[{id:'dark',name:'Navy (no labels)'},{id:'darklabel',name:'Dark (with labels)'},...BASE_LAYERS.filter(l=>l.id!=='osm')]:BASE_LAYERS,dlDefs=[{k:'incidents',l:_('incidents')},{k:'access',l:_('noAccess')},{k:'risks',l:_('risks')},{k:'corridor',l:_('corridor')}]
useEffect(()=>{document.documentElement.setAttribute('data-theme',theme);ss('theme',theme)},[theme]);useEffect(()=>{document.documentElement.style.setProperty('--fs',fs+'px');ss('fs',fs)},[fs]);useEffect(()=>{ss('po',panelOpen)},[panelOpen]);useEffect(()=>{const p=aiProviders.find(p=>p.id===activeProvider);setAiStatus(p?.key?'ready':'unconfigured');setApiKey(p?.key||'');setAiModel(activeModel);ss('aip',aiProviders);ss('apv',activeProvider);ss('amd',activeModel)},[aiProviders,activeProvider,activeModel]);useEffect(()=>{ss('am',aiModel);ss('events',events);ss('ae',activeEventId);ss('ma',mapAnims);ss('lang',lang);ss('ak',apiKey)},[aiModel,events,activeEventId,mapAnims,lang,apiKey]);useEffect(()=>{ceR.current?.scrollIntoView({behavior:'smooth'})},[cMsgs]);useEffect(()=>{const h=e=>{if(stR.current&&!stR.current.contains(e.target))setShowSettings(false)};document.addEventListener('mousedown',h);return()=>document.removeEventListener('mousedown',h)},[]);useEffect(()=>{const h=e=>{if(e.key==='Escape'){setDetailOpen(false);setShowShareModal(false);setShowExportMenu(false);setShowIncForm(false);setMapClickMode(false);setShowAddMenu(false)}};window.addEventListener('keydown',h);return()=>window.removeEventListener('keydown',h)},[]);useEffect(()=>{const el=document.getElementById('root');if(el){if(mapAnims)el.classList.remove('no-anim');else el.classList.add('no-anim')}},[mapAnims])
useEffect(()=>{if(ae?.region)setGeoBias(ae.region)},[activeEventId])
useEffect(()=>{window.__cpViewDetail=(type,id)=>{setDetailOpen(true);if(type==='incident'){setDetailTab('incidents');const inc=(ae?.incidents||[]).find(i=>i.id===id);if(inc)setTimeout(()=>{const el=document.querySelector(`[data-inc-id="${id}"]`);if(el){el.scrollIntoView({behavior:'smooth',block:'center'});el.style.boxShadow='0 0 0 2px var(--accent)';setTimeout(()=>el.style.boxShadow='',2000)}},100)}else if(type==='waypoint'||type==='base'){setDetailTab('overview')}else if(type==='risk'){setDetailTab('incidents')}};return()=>{delete window.__cpViewDetail}},[ae])
useEffect(()=>{if(mR.current)return;import('leaflet').then(mod=>{const Lf=mod.default||mod;LR.current=Lf;delete Lf.Icon.Default.prototype._getIconUrl;Lf.Icon.Default.mergeOptions({iconRetinaUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',iconUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'});const map=Lf.map(mcR.current,{zoomControl:true}).setView([9.5,30.5],6);mR.current=map;const bl=mkTile(Lf,baseLayerId,theme);bl.addTo(map);blR.current=bl;if(ae){const layers=renderEventToMap(Lf,ae,mapAnims,true);Object.values(layers).forEach(l=>l.addTo(map));elR.current=layers;if(ae.region?.bounds)map.fitBounds(ae.region.bounds,{padding:[30,30]})}})},[])
useEffect(()=>{const map=mR.current,Lf=LR.current;if(!map||!Lf)return;const h=e=>{if(!mapClickMode)return;setIncForm(p=>({...p,a:+e.latlng.lat.toFixed(4),o:+e.latlng.lng.toFixed(4)}));if(cmR.current)map.removeLayer(cmR.current);cmR.current=Lf.circleMarker([e.latlng.lat,e.latlng.lng],{radius:12,fillColor:'#C9A84C',color:'#FFF',weight:3,fillOpacity:.7}).addTo(map);setMapClickMode(false)};map.on('click',h);return()=>map.off('click',h)},[mapClickMode])
useEffect(()=>{const map=mR.current,Lf=LR.current;if(!map||!Lf||!ae)return;Object.values(elR.current).forEach(l=>{try{map.removeLayer(l)}catch{}});const layers=renderEventToMap(Lf,ae,mapAnims,true);Object.entries(layers).forEach(([k,l])=>{if(dataLayers[k]!==false)l.addTo(map)});elR.current=layers;if(ae.region?.bounds)map.fitBounds(ae.region.bounds,{padding:[30,30],animate:true});else if(ae.region?.center)map.setView(ae.region.center,ae.region.zoom||2,{animate:true,duration:1});setTimeout(()=>map.invalidateSize(),200)},[activeEventId])
useEffect(()=>{const map=mR.current,Lf=LR.current;if(!map||!Lf)return;if(blR.current)map.removeLayer(blR.current);const l=mkTile(Lf,baseLayerId,theme);l.addTo(map);l.bringToBack();blR.current=l;ss('bl',baseLayerId)},[baseLayerId,theme])
useEffect(()=>{const map=mR.current,Lf=LR.current;if(!map||!Lf)return;if(snR.current){map.removeLayer(snR.current);snR.current=null};if(sentinel2){const s=Lf.tileLayer.wms('https://sh.dataspace.copernicus.eu/ogc/wms/'+COPERNICUS_INSTANCE,{layers:'TRUE-COLOR',tileSize:512,format:'image/png',transparent:true,maxcc:30,minZoom:6,maxZoom:16,time:'2025-10-01/2026-02-12'});s.addTo(map);snR.current=s}},[sentinel2])
const toggleDL=useCallback(k=>{setDataLayers(p=>{const n={...p,[k]:!p[k]};const map=mR.current,g=elR.current[k];if(map&&g){if(n[k])g.addTo(map);else map.removeLayer(g)}return n})},[])
useEffect(()=>{if(view==='map'&&mR.current)setTimeout(()=>mR.current.invalidateSize(),200)},[view,panelOpen,detailOpen])
const upEv=(id,patch)=>setEvents(p=>p.map(e=>e.id===id?{...e,...patch,updatedAt:new Date().toISOString().slice(0,10)}:e))
const reMap=ev=>{const map=mR.current,Lf=LR.current;if(!map||!Lf)return;Object.values(elR.current).forEach(l=>{try{map.removeLayer(l)}catch{}});const layers=renderEventToMap(Lf,ev,mapAnims,true);Object.entries(layers).forEach(([k,l])=>{if(dataLayers[k]!==false)l.addTo(map)});elR.current=layers}
const addEv=type=>{const ev=createEvent({name:(EVENT_TYPES.find(t=>t.id===type)?.name||'Event')+' '+(events.length+1),type});setEvents(p=>[...p,ev]);setActiveEventId(ev.id);setDetailOpen(true);setDetailTab('ai');setShowAddMenu(false);if(mR.current)mR.current.setView([20,0],2,{animate:true,duration:1})}
const delEv=id=>{if(events.length<=1)return;setEvents(p=>p.filter(e=>e.id!==id));if(activeEventId===id)setActiveEventId(events.find(e=>e.id!==id)?.id);setDetailOpen(false)}
const selEv=id=>{setActiveEventId(id);setDetailOpen(true);setDetailTab('ai')}
const addBrief=()=>{const txt=briefInput.trim();if(!txt)return;upEv(activeEventId,{briefs:[...(ae.briefs||[]),{id:'b_'+Date.now(),text:txt,ts:new Date().toISOString(),archived:false}],brief:txt});setBriefInput('')}
const archBrief=bid=>{const bs=(ae.briefs||[]).map(b=>b.id===bid?{...b,archived:true}:b);upEv(activeEventId,{briefs:bs,brief:bs.filter(b=>!b.archived).pop()?.text||''})}
const saveBriefEdit=bid=>{upEv(activeEventId,{briefs:(ae.briefs||[]).map(b=>b.id===bid?{...b,text:editBriefText}:b)});setEditBriefId(null)}
const startEditInc=inc=>{setEditIncId(inc.id);setEditInc({...inc})}
const saveEditInc=()=>{if(!editInc)return;const mg=(ae.incidents||[]).map(i=>i.id===editIncId?editInc:i);upEv(activeEventId,{incidents:mg});reMap({...ae,incidents:mg});setEditIncId(null);setEditInc(null)}
const deleteInc=id=>{const mg=(ae.incidents||[]).filter(i=>i.id!==id);upEv(activeEventId,{incidents:mg});reMap({...ae,incidents:mg});setEditIncId(null);setEditInc(null)}
const flyTo=(a,o)=>mR.current?.setView([a,o],9)
// Universal AI call â€” supports Anthropic, OpenAI-compatible (GPT, DeepSeek, Grok), Google Gemini
const callAI=async(messages,system,maxTokens=1024)=>{
  const prov=aiProviders.find(p=>p.id===activeProvider);if(!prov?.key)throw new Error('No API key for '+prov?.name);
  const model=activeModel
  if(prov.id==='anthropic'){
    const r=await fetch(prov.url,{method:'POST',headers:{'Content-Type':'application/json','x-api-key':prov.key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model,max_tokens:maxTokens,system:system||undefined,messages})});const d=await r.json();if(d.error)throw new Error(d.error.message);return(d.content||[]).map(b=>b.text||'').join('')
  }else if(prov.id==='google'){
    const url=prov.url.replace('{model}',model)+'?key='+prov.key;const parts=messages.map(m=>({role:m.role==='user'?'user':'model',parts:[{text:m.content}]}));const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:parts,systemInstruction:system?{parts:[{text:system}]}:undefined,generationConfig:{maxOutputTokens:maxTokens}})});const d=await r.json();if(d.error)throw new Error(d.error.message);return d.candidates?.[0]?.content?.parts?.[0]?.text||''
  }else{
    // OpenAI-compatible: GPT, DeepSeek, Grok, Kimi
    const msgs=system?[{role:'system',content:system},...messages]:messages;const r=await fetch(prov.url,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+prov.key},body:JSON.stringify({model,max_tokens:maxTokens,messages:msgs})});const d=await r.json();if(d.error)throw new Error(d.error?.message||JSON.stringify(d.error));return d.choices?.[0]?.message?.content||''
  }
}
const analyzeBrief=async txt=>{const text=txt||briefInput.trim()||ae.brief;if(!text){setChatMsgs(p=>({...p,[activeEventId]:[...(p[activeEventId]||[]),{role:'a',text:'âš ï¸ No text to analyze. Paste a brief first or add one in the Briefs tab.'}]}));return};setBriefAnalyzing(true);setChatMsgs(p=>({...p,[activeEventId]:[...(p[activeEventId]||[]),{role:'a',text:'ğŸ” Analyzing text... extracting locations and incidents.'}]}));const applyIncidents=(ni,source)=>{if(ni.length){const mg=[...(ae.incidents||[]),...ni];
      // Auto-set region bounds from incident locations for future geocoding accuracy
      const lats=ni.map(i=>i.a),lons=ni.map(i=>i.o);
      const minLat=Math.min(...lats)-2,maxLat=Math.max(...lats)+2,minLon=Math.min(...lons)-2,maxLon=Math.max(...lons)+2;
      const newRegion={center:[(minLat+maxLat)/2,(minLon+maxLon)/2],zoom:7,bounds:[[minLat,minLon],[maxLat,maxLon]]};
      upEv(activeEventId,{incidents:mg,region:newRegion});setGeoBias(newRegion);
      reMap({...ae,incidents:mg,region:newRegion});mR.current?.fitBounds([[minLat,minLon],[maxLat,maxLon]],{padding:[40,40],animate:true})
    };setChatMsgs(p=>({...p,[activeEventId]:[...(p[activeEventId]||[]),{role:'a',text:ni.length?`ğŸ—ºï¸ Mapped ${ni.length} incident(s) via ${source}. Check the map!`:`No incidents extracted via ${source}. Include place names like cities, towns, or regions.`}]}))};if(!apiKey){try{const ni=await localParseBrief(text,pct=>setChatMsgs(p=>({...p,[activeEventId]:[...(p[activeEventId]||[]).slice(0,-1),{role:'a',text:`ğŸ” Geocoding locations... ${pct}%`}]})));applyIncidents(ni,'Local Parser + Nominatim')}catch(e){setChatMsgs(p=>({...p,[activeEventId]:[...(p[activeEventId]||[]),{role:'a',text:'âŒ Parse error: '+e.message}]}))};setBriefAnalyzing(false);return};try{const raw=await callAI([{role:'user',content:BRIEF_ANALYSIS_PROMPT+' '+text}],null,2048);const m=raw.match(/\[[\s\S]*\]/);if(m){const ps=JSON.parse(m[0]);const ni=ps.filter(p=>typeof p.a==='number'&&typeof p.o==='number').map((p,i)=>({id:'ai_'+Date.now()+'_'+i,dt:p.dt||new Date().toISOString().slice(0,10),a:p.a,o:p.o,tp:p.tp||'displacement',s:p.s||'medium',ti:p.ti||'AI',d:p.d||'',ac:p.ac||'Unknown',og:p.og||'AI'}));const provName=aiProviders.find(p=>p.id===activeProvider)?.name||'AI';applyIncidents(ni,provName+' ('+activeModel+')')}else{const ni=await localParseBrief(text);applyIncidents(ni,'Local Parser (AI returned no JSON)')}}catch(e){try{const ni=await localParseBrief(text);applyIncidents(ni,'Local Parser ('+e.message+')')}catch(e2){setChatMsgs(p=>({...p,[activeEventId]:[...(p[activeEventId]||[]),{role:'a',text:'âŒ All parsers failed: '+e2.message}]}))}};setBriefAnalyzing(false)}
const sendMsg=async()=>{const msg=inputVal.trim();if(!msg||busy)return;const eid=activeEventId;if(!apiKey){setChatMsgs(p=>({...p,[eid]:[...(p[eid]||[]),{role:'u',text:msg},{role:'a',text:'âš ï¸ Configure API key in Settings â†’ ğŸ¤–'}]}));setInputVal('');return};setChatMsgs(p=>({...p,[eid]:[...(p[eid]||[]),{role:'u',text:msg}]}));setInputVal('');setBusy(true);const hist=[...(chatHist[eid]||[]),{role:'user',content:msg}];setChatHist(p=>({...p,[eid]:hist}));try{const txt=await callAI(hist.slice(-12),buildSystemPrompt(ae));setChatMsgs(p=>({...p,[eid]:[...(p[eid]||[]),{role:'a',text:txt||'â€”'}]}));setChatHist(p=>({...p,[eid]:[...(p[eid]||[]),{role:'assistant',content:txt}]}))}catch(e){setChatMsgs(p=>({...p,[eid]:[...(p[eid]||[]),{role:'a',text:'âŒ '+e.message}]}))};setBusy(false)}
const testKey=async()=>{if(!apiKey)return;setBusy(true);try{const txt=await callAI([{role:'user',content:'Reply OK'}],null,20);setAiStatus('ready');alert('âœ… '+activeProvider+' connected!')}catch(e){setAiStatus('error');alert('âŒ '+e.message)};setBusy(false)}
const addNote=()=>{const txt=noteInput.trim();if(!txt)return;upEv(activeEventId,{notebook:[...(ae.notebook||[]),{id:'n_'+Date.now(),author:'User',type:'note',text:txt,ts:new Date().toISOString()}]});setNoteInput('')}
const noteText=text=>{const ps=text.split(/(@[\w-]+)/g);return ps.map((p,i)=>{if(p.startsWith('@')){const inc=(ae?.incidents||[]).find(x=>x.id===p.slice(1)||x.ti.toLowerCase().includes(p.slice(1).toLowerCase()));if(inc)return<span key={i} onClick={()=>flyTo(inc.a,inc.o)} style={{color:'var(--accent)',cursor:'pointer',fontWeight:600,textDecoration:'underline dotted'}}>{p}</span>}return<span key={i}>{p}</span>})}
const genShare=()=>{setShareUrl(location.origin+location.pathname+'#/share/'+encodeShare(ae,sharePwOn?sharePw:''));setShowShareModal(true)}
const cpShare=()=>{navigator.clipboard.writeText(shareUrl).then(()=>{setCopyFb(_('copied'));setTimeout(()=>setCopyFb(''),2000)})}
const subInc=()=>{if(!incForm.ti||incForm.a===null)return;const ni={id:'inc_'+Date.now(),dt:new Date().toISOString().slice(0,10),a:incForm.a,o:incForm.o,tp:incForm.tp,s:incForm.s,ti:incForm.ti,d:incForm.d,ac:incForm.ac||'Unknown',og:incForm.og||'Field'};const mg=[...(ae.incidents||[]),ni];let patch={incidents:mg};if(incForm.drawType==='circle')patch.drawings=[...(ae.drawings||[]),{type:'circle',a:incForm.a,o:incForm.o,r:incForm.drawR*1000,color:(SEVERITY[incForm.s]||SEVERITY.medium).color,label:incForm.ti}];upEv(activeEventId,patch);reMap({...ae,...patch});mR.current?.setView([ni.a,ni.o],9);if(cmR.current){mR.current.removeLayer(cmR.current);cmR.current=null};setShowIncForm(false);setIncForm({ti:'',d:'',tp:'displacement',s:'medium',ac:'',og:'',a:null,o:null,drawType:null,drawR:50})}
const loadInfra=async type=>{const map=mR.current,Lf=LR.current;if(!map||!Lf)return;if(igR.current[type]){map.removeLayer(igR.current[type]);delete igR.current[type];setInfraLayers(p=>{const n={...p};delete n[type];return n});return};setInfraLoading(type);try{const q=buildOverpassQuery(type,map.getBounds());const r=await fetch('https://overpass-api.de/api/interpreter',{method:'POST',body:'data='+encodeURIComponent(q)});const d=await r.json();const g=Lf.layerGroup();const col={hospitals:'#E8553A',water:'#4BA8CC',roads:'#8B7355'};(d.elements||[]).forEach(el=>{const lat=el.lat||el.center?.lat,lon=el.lon||el.center?.lon,tags=el.tags||{};if(type==='roads'&&el.geometry)Lf.polyline(el.geometry.map(p=>[p.lat,p.lon]),{color:col[type],weight:2,opacity:.6}).bindPopup(`<b>${tags.name||'Road'}</b><br>${tags.highway||''} ${tags.ref||''}`).addTo(g);else if(lat&&lon){Lf.circleMarker([lat,lon],{radius:7,fillColor:col[type],color:'#FFF',weight:1,fillOpacity:.9}).bindPopup(type==='hospitals'?`<b>ğŸ¥ ${tags.name||'Hospital/Clinic'}</b><br>${[tags['addr:street'],tags['addr:city']].filter(Boolean).join(', ')}<br>${tags.phone?'ğŸ“ '+tags.phone:''}<br>${tags.operator?'ğŸ›ï¸ '+tags.operator:''}<br>${tags.beds?'ğŸ›ï¸ Beds: '+tags.beds:''}<br>${tags.emergency?'âš¡ Emergency: '+tags.emergency:''}<br><small style="color:#888">OSM/Overpass</small>`:`<b>${{water:'ğŸ’§'}[type]||'ğŸ“'} ${tags.name||type}</b><br>${tags.operator||''}<br><small>OSM</small>`).addTo(g);Lf.circle([lat,lon],{radius:800,fillColor:col[type],color:col[type],weight:1,fillOpacity:.06,dashArray:'4 3'}).addTo(g)}});g.addTo(map);igR.current[type]=g;setInfraLayers(p=>({...p,[type]:true}))}catch(e){console.error(e)};setInfraLoading('')}
const flowData=()=>{const nodes=[],links=[];events.forEach((ev,ei)=>{const nx=150+ei*280,ny=60;nodes.push({id:ev.id,label:ev.name.slice(0,16),x:nx,y:ny,color:(SEVERITY[ev.severity]||SEVERITY.medium).color,r:40,type:'event'});(ev.incidents||[]).forEach((inc,ii)=>{const ix=nx-60+(ii%4)*50,iy=ny+110+Math.floor(ii/4)*60;const nid=ev.id+'_'+inc.id;nodes.push({id:nid,label:(ICON_MAP[inc.tp]||'âš ï¸')+inc.ti.slice(0,10),x:ix,y:iy,color:(SEVERITY[inc.s]||SEVERITY.medium).color,r:22,type:'incident'});links.push([ev.id,nid])});if(ei>0)links.push([events[ei-1].id,ev.id])});return{nodes,links}}
return(<div className="app-layout">
<div className={`panel${panelOpen?'':' collapsed'}`}><div className="sidebar-toggle" onClick={()=>setPanelOpen(v=>!v)}>â—€</div>
<div style={{padding:'12px 14px 8px',borderBottom:'1px solid var(--border-subtle)'}}><div style={{display:'flex',alignItems:'center',gap:8}}><span style={{width:8,height:8,borderRadius:'50%',background:'var(--danger)',boxShadow:'0 0 6px var(--danger-glow)'}}/><b style={{fontSize:'calc(var(--fs)*.88)',letterSpacing:'.04em'}}>{_('corridorPlanner')}</b><span style={{fontSize:'calc(var(--fs)*.48)',color:aiStatus==='ready'?'var(--success)':'var(--text-faint)',padding:'2px 6px',borderRadius:3,fontWeight:700,marginLeft:'auto',background:aiStatus==='ready'?'var(--success)11':'transparent'}}>{aiStatus==='ready'?'ğŸŸ¢':'âšª'} AI</span></div></div>
<div style={{padding:'8px 14px',display:'flex',gap:5,borderBottom:'1px solid var(--border-subtle)'}}><div style={{flex:1,position:'relative'}}><input value={searchQuery} onChange={e=>setSearchQuery(e.target.value)} placeholder={_('searchEvents')} style={{...inp,paddingLeft:28}}/><span style={{position:'absolute',left:9,top:'50%',transform:'translateY(-50%)',fontSize:'calc(var(--fs)*.72)',color:'var(--text-faint)',pointerEvents:'none'}}>ğŸ”</span></div><div style={{position:'relative'}}><button onClick={()=>setShowAddMenu(v=>!v)} style={{width:34,height:34,borderRadius:7,border:'1px solid var(--border-input)',background:'var(--surface-card)',color:'var(--accent)',cursor:'pointer',fontSize:'calc(var(--fs)*1)',fontWeight:700}}>+</button>{showAddMenu&&<div style={{position:'absolute',top:'100%',right:0,marginTop:4,background:'var(--bg-secondary)',border:'1px solid var(--border-primary)',borderRadius:8,boxShadow:'var(--shadow-lg)',zIndex:10,minWidth:180,overflow:'hidden',animation:'fadeIn .15s ease'}}><div style={{padding:'8px 12px',borderBottom:'1px solid var(--border-subtle)',fontSize:'calc(var(--fs)*.65)',fontWeight:700,color:'var(--text-muted)'}}>{_('newEvent')}</div>{EVENT_TYPES.map(et=><button key={et.id} onClick={()=>addEv(et.id)} style={{display:'flex',alignItems:'center',gap:8,width:'100%',padding:'8px 12px',border:'none',background:'transparent',cursor:'pointer',fontSize:'calc(var(--fs)*.7)',color:'var(--text-secondary)',fontFamily:'inherit'}} onMouseEnter={e=>e.currentTarget.style.background='var(--bg-hover)'} onMouseLeave={e=>e.currentTarget.style.background='transparent'}><span>{et.icon}</span>{et.name}</button>)}</div>}</div></div>
<div style={{padding:'6px 14px',borderBottom:'1px solid var(--border-subtle)',background:'var(--surface-card)'}}><div style={{display:'flex',gap:4,marginBottom:5}}>{['map','flow'].map(v=><button key={v} onClick={()=>setView(v)} style={{flex:1,padding:'5px 0',borderRadius:5,border:'none',cursor:'pointer',fontSize:'calc(var(--fs)*.65)',fontWeight:600,fontFamily:'inherit',background:view===v?'var(--text-primary)':'transparent',color:view===v?'var(--bg-secondary)':'var(--text-muted)'}}>{v==='map'?'ğŸ—ºï¸ '+_('map'):'ğŸ”€ '+_('flow')}</button>)}</div><div style={{display:'flex',gap:3,flexWrap:'wrap'}}>{dlDefs.map(d=><button key={d.k} onClick={()=>toggleDL(d.k)} style={{padding:'2px 6px',borderRadius:4,cursor:'pointer',fontSize:'calc(var(--fs)*.52)',fontFamily:'inherit',fontWeight:600,background:dataLayers[d.k]?'var(--accent-bg)':'transparent',color:dataLayers[d.k]?'var(--accent)':'var(--text-faint)',border:'none'}}>{dataLayers[d.k]?'â—':'â—‹'} {d.l}</button>)}</div>{Object.keys(typeCounts).length>0&&<div style={{display:'flex',gap:4,marginTop:4,flexWrap:'wrap'}}>{Object.entries(typeCounts).map(([tp,c])=><span key={tp} style={{fontSize:'calc(var(--fs)*.5)',padding:'1px 5px',borderRadius:3,background:'var(--bg-hover)',color:'var(--text-muted)'}}>{ICON_MAP[tp]||'âš ï¸'}{c}</span>)}</div>}</div>
<div style={{flex:1,overflowY:'auto',padding:'6px 8px'}}>{fEvts.length===0&&<div style={{textAlign:'center',padding:16,color:'var(--text-faint)'}}>{_('noEvents')}</div>}{fEvts.map(ev=>{const et=EVENT_TYPES.find(t=>t.id===ev.type);return<div key={ev.id} onClick={()=>selEv(ev.id)} style={{padding:'10px 12px',borderRadius:8,cursor:'pointer',marginBottom:4,background:ev.id===activeEventId?'var(--accent-bg)':'transparent',border:'1px solid '+(ev.id===activeEventId?'var(--accent)':'var(--border-subtle)')}} onMouseEnter={e=>{if(ev.id!==activeEventId)e.currentTarget.style.background='var(--bg-hover)'}} onMouseLeave={e=>{if(ev.id!==activeEventId)e.currentTarget.style.background='transparent'}}><div style={{display:'flex',alignItems:'center',gap:6}}>{et&&<span style={{fontSize:'calc(var(--fs)*.72)'}}>{et.icon}</span>}<b style={{fontSize:'calc(var(--fs)*.78)',flex:1,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{ev.name}</b><span style={svB(ev.severity)}>{ev.severity?.toUpperCase()}</span></div><div style={{fontSize:'calc(var(--fs)*.55)',color:'var(--text-muted)',marginTop:3,paddingLeft:20,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{ev.brief||'â€”'}</div></div>})}</div>
{stats.length>0&&<div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:3,padding:'6px 10px',borderTop:'1px solid var(--border-subtle)',background:'var(--surface-card)'}}>{stats.map(s=><div key={s.label} style={{padding:'5px 2px',borderRadius:4,textAlign:'center'}}><div style={{fontSize:'calc(var(--fs)*1)',fontWeight:700,color:s.color}}>{s.value}</div><div style={{fontSize:'calc(var(--fs)*.42)',color:'var(--text-muted)'}}>{s.label}</div></div>)}</div>}
<div ref={stR} style={{borderTop:'1px solid var(--border-subtle)',position:'relative'}}><button onClick={()=>setShowSettings(v=>!v)} style={{width:'100%',padding:'10px 14px',border:'none',background:showSettings?'var(--accent-bg)':'var(--bg-secondary)',cursor:'pointer',display:'flex',alignItems:'center',gap:8,fontFamily:'inherit',fontSize:'calc(var(--fs)*.72)',color:'var(--text-muted)',fontWeight:600}}>âš™ï¸ {_('settings')}<span style={{marginLeft:'auto',fontSize:'calc(var(--fs)*.5)',color:'var(--text-faint)'}}>v3</span></button>
{showSettings&&<div style={{position:'absolute',bottom:'100%',left:0,right:0,maxHeight:'60vh',overflowY:'auto',background:'var(--bg-secondary)',border:'1px solid var(--border-primary)',borderBottom:'none',borderRadius:'12px 12px 0 0',boxShadow:'var(--shadow-lg)',animation:'fadeIn .2s ease'}}><div style={{display:'flex',gap:2,padding:'8px 12px 0',borderBottom:'1px solid var(--border-subtle)'}}>{[{id:'appearance',l:'ğŸ¨'},{id:'map',l:'ğŸ—ºï¸'},{id:'ai',l:'ğŸ¤–'},{id:'about',l:'â„¹ï¸'}].map(tb=><button key={tb.id} onClick={()=>setSettingsTab(tb.id)} style={{padding:'5px 10px',border:'none',background:'transparent',cursor:'pointer',fontSize:'calc(var(--fs)*.82)',fontFamily:'inherit',color:settingsTab===tb.id?'var(--accent)':'var(--text-faint)',borderBottom:settingsTab===tb.id?'2px solid var(--accent)':'2px solid transparent'}}>{tb.l}</button>)}</div><div style={{padding:'12px 14px'}}>
{settingsTab==='appearance'&&<><div style={{marginBottom:12}}><div style={{fontSize:'calc(var(--fs)*.68)',fontWeight:700,marginBottom:5}}>{_('theme')}</div><div style={{display:'flex',background:'var(--surface-card)',borderRadius:7,overflow:'hidden'}}>{['light','dark'].map(tm=><button key={tm} onClick={()=>{setTheme(tm);if(tm==='dark'&&baseLayerId==='osm')setBaseLayerId('dark');if(tm==='light'&&baseLayerId==='dark')setBaseLayerId('osm')}} style={{flex:1,padding:'8px 0',border:'none',cursor:'pointer',fontFamily:'inherit',fontWeight:600,fontSize:'calc(var(--fs)*.68)',background:theme===tm?'var(--accent)':'transparent',color:theme===tm?'#FFF':'var(--text-muted)'}}>{tm==='light'?'â˜€ï¸':'ğŸŒ™'} {_(tm)}</button>)}</div></div><div style={{marginBottom:12}}><div style={{display:'flex',justifyContent:'space-between'}}><span style={{fontSize:'calc(var(--fs)*.65)',fontWeight:600}}>{_('fontSize')}</span><span style={{fontSize:'calc(var(--fs)*.65)',color:'var(--text-muted)'}}>{fs}px</span></div><input type="range" min="10" max="20" value={fs} onChange={e=>setFs(+e.target.value)} style={{width:'100%',accentColor:'var(--accent)'}}/></div><label style={{display:'flex',alignItems:'center',gap:8,fontSize:'calc(var(--fs)*.68)',cursor:'pointer',marginBottom:12}}><input type="checkbox" checked={mapAnims} onChange={e=>setMapAnims(e.target.checked)} style={{accentColor:'var(--accent)'}}/>{_('mapAnims')} {mapAnims?'âœ¨':''}</label><div><div style={{fontSize:'calc(var(--fs)*.68)',fontWeight:700,marginBottom:5}}>{_('language')}</div><div style={{display:'flex',gap:3,flexWrap:'wrap'}}>{LANGS.map(l=><button key={l.id} onClick={()=>setLang(l.id)} style={{padding:'5px 10px',borderRadius:5,border:'1px solid '+(lang===l.id?'var(--accent)':'var(--border-primary)'),background:lang===l.id?'var(--accent-bg)':'transparent',color:lang===l.id?'var(--accent)':'var(--text-muted)',cursor:'pointer',fontFamily:'inherit',fontSize:'calc(var(--fs)*.65)',fontWeight:600}}>{l.name}</button>)}</div></div></>}
{settingsTab==='map'&&<><div style={{marginBottom:10}}><div style={{fontSize:'calc(var(--fs)*.68)',fontWeight:700,marginBottom:5}}>{_('baseLayer')}</div>{layerOpts.map(b=><label key={b.id} style={{display:'flex',alignItems:'center',gap:6,padding:'4px 6px',cursor:'pointer',fontSize:'calc(var(--fs)*.68)'}}><input type="radio" name="bl" checked={baseLayerId===b.id} onChange={()=>setBaseLayerId(b.id)} style={{accentColor:'var(--accent)'}}/>{b.name}</label>)}</div><label style={{display:'flex',alignItems:'center',gap:6,padding:'4px 6px',fontSize:'calc(var(--fs)*.68)',cursor:'pointer',borderTop:'1px solid var(--border-subtle)',paddingTop:8}}><input type="checkbox" checked={sentinel2} onChange={e=>setSentinel2(e.target.checked)} style={{accentColor:'var(--accent)'}}/><b>Sentinel-2</b><span style={{fontSize:'calc(var(--fs)*.5)',color:'var(--text-faint)'}}>(satellite overlay â€” zoom â‰¥6)</span></label><div style={{borderTop:'1px solid var(--border-subtle)',paddingTop:8,marginTop:8}}><div style={{fontSize:'calc(var(--fs)*.68)',fontWeight:700,marginBottom:3}}>{_('infra')} â€” Overpass API</div><div style={{fontSize:'calc(var(--fs)*.52)',color:'var(--text-muted)',marginBottom:5}}>Real-time from OpenStreetMap. Zoom in first.</div><div style={{display:'flex',gap:4,flexWrap:'wrap'}}>{[{k:'hospitals',l:_('hospitals'),e:'ğŸ¥'},{k:'water',l:_('waterPoints'),e:'ğŸ’§'},{k:'roads',l:_('roads'),e:'ğŸ›£ï¸'}].map(i=><button key={i.k} onClick={()=>loadInfra(i.k)} style={{padding:'5px 10px',borderRadius:5,cursor:'pointer',fontSize:'calc(var(--fs)*.62)',fontFamily:'inherit',fontWeight:600,background:infraLayers[i.k]?'var(--accent)':'var(--surface-card)',color:infraLayers[i.k]?'#FFF':'var(--text-muted)',border:'none'}}>{infraLoading===i.k?<span style={{display:'inline-block',width:12,height:12,border:'2px solid currentColor',borderTopColor:'transparent',borderRadius:'50%',animation:'spin .8s linear infinite'}}/>:i.e} {i.l}</button>)}</div></div></>}
{settingsTab==='ai'&&<><div style={{fontSize:'calc(var(--fs)*.62)',fontWeight:700,marginBottom:6,textTransform:'uppercase',color:'var(--text-muted)'}}>AI Providers</div>{aiProviders.map((prov,pi)=><div key={prov.id} style={{padding:'8px 10px',borderRadius:7,marginBottom:6,border:'1px solid '+(activeProvider===prov.id?'var(--accent)':'var(--border-primary)'),background:activeProvider===prov.id?'var(--accent-bg)':'var(--surface-card)',cursor:'pointer'}} onClick={()=>{setActiveProvider(prov.id);if(prov.models.length)setActiveModel(prov.models[0])}}><div style={{display:'flex',alignItems:'center',gap:6,marginBottom:prov.key||activeProvider===prov.id?4:0}}><span style={{width:7,height:7,borderRadius:'50%',background:prov.key?'#5AAE7A':'var(--text-faint)'}}/><b style={{flex:1,fontSize:'calc(var(--fs)*.7)'}}>{prov.name}</b>{activeProvider===prov.id&&<span style={{fontSize:'calc(var(--fs)*.48)',padding:'1px 5px',borderRadius:3,background:'var(--accent)',color:'#FFF',fontWeight:700}}>ACTIVE</span>}</div>{activeProvider===prov.id&&<><div style={{display:'flex',gap:3,marginBottom:4}}><input type="password" value={prov.key} onClick={e=>e.stopPropagation()} onChange={e=>{const np=[...aiProviders];np[pi]={...np[pi],key:e.target.value};setAiProviders(np)}} placeholder={prov.id==='anthropic'?'sk-ant-...':prov.id==='openai'?'sk-...':prov.id==='google'?'AIza...':'API key'} style={{...inp,flex:1,fontFamily:'monospace',fontSize:'calc(var(--fs)*.6)'}}/><button onClick={e=>{e.stopPropagation();testKey()}} disabled={!prov.key||busy} style={{padding:'5px 8px',borderRadius:5,border:'none',background:'var(--surface-card)',color:'var(--text-secondary)',cursor:prov.key&&!busy?'pointer':'not-allowed',fontFamily:'inherit',fontSize:'calc(var(--fs)*.58)',fontWeight:600}}>Test</button></div><div style={{display:'flex',gap:2,flexWrap:'wrap'}}>{prov.models.map(m=><button key={m} onClick={e=>{e.stopPropagation();setActiveModel(m)}} style={{padding:'3px 7px',borderRadius:4,border:'none',cursor:'pointer',fontSize:'calc(var(--fs)*.55)',fontFamily:'inherit',fontWeight:600,background:activeModel===m?'var(--accent)':'var(--bg-hover)',color:activeModel===m?'#FFF':'var(--text-muted)'}}>{m.split('/').pop().replace(/-/g,' ')}</button>)}</div></>}</div>)}<div style={{display:'flex',alignItems:'center',gap:5,marginTop:8,paddingTop:6,borderTop:'1px solid var(--border-subtle)'}}><span style={{width:6,height:6,borderRadius:'50%',background:aiStatus==='ready'?'#5AAE7A':'var(--text-faint)'}}/><span style={{fontSize:'calc(var(--fs)*.58)',color:'var(--text-muted)'}}>{aiStatus==='ready'?(aiProviders.find(p=>p.id===activeProvider)?.name+' Â· '+activeModel.split('/').pop()):'No provider configured'}</span></div></>}
{settingsTab==='about'&&<div style={{fontSize:'calc(var(--fs)*.68)',color:'var(--text-secondary)',lineHeight:1.8}}><b>Corridor Planner v3</b><br/>EN/TR/FR/AR Â· Overpass API Â· Claude AI</div>}
</div></div>}</div>
</div>
<div className="canvas">
{!panelOpen&&<div onClick={()=>setPanelOpen(true)} style={{position:'absolute',top:'50%',left:0,transform:'translateY(-50%)',zIndex:1100,width:26,height:52,background:'var(--bg-secondary)',border:'1px solid var(--border-primary)',borderLeft:'none',borderRadius:'0 8px 8px 0',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',color:'var(--text-muted)',fontSize:14,boxShadow:'var(--shadow-sm)'}}>â–¶</div>}
<div ref={mcR} style={{width:'100%',height:'100%',display:view==='map'?'block':'none',cursor:mapClickMode?'crosshair':'grab'}}/>
{view==='flow'&&(()=>{const{nodes,links}=flowData();return<div style={{width:'100%',height:'100%',background:'var(--bg-primary)',overflow:'auto'}}><svg width={Math.max(900,nodes.length*80)} height={600}>{links.map(([f,tt],i)=>{const fn=nodes.find(n=>n.id===f),tn=nodes.find(n=>n.id===tt);return fn&&tn?<line key={i} x1={fn.x} y1={fn.y} x2={tn.x} y2={tn.y} stroke={fn.color} strokeWidth="1.5" opacity=".3" strokeDasharray="4 3"/>:null})}{nodes.map(n=><g key={n.id} style={{cursor:'pointer'}} onClick={()=>{if(n.type==='event'){setActiveEventId(n.id);setView('map')}}}><circle cx={n.x} cy={n.y} r={n.r+8} fill={n.color} opacity=".06"/><circle cx={n.x} cy={n.y} r={n.r} fill="var(--bg-secondary)" stroke={n.color} strokeWidth={n.type==='event'?2.5:1.5}/><text x={n.x} y={n.y} textAnchor="middle" dominantBaseline="middle" fill="var(--text-primary)" fontSize={n.type==='event'?11:8} fontWeight={n.type==='event'?700:400} fontFamily="'Source Serif 4',serif">{n.label}</text></g>)}</svg></div>})()}
{view==='map'&&<>
<div style={{position:'absolute',top:12,left:44,zIndex:1000,pointerEvents:'none',display:'flex',gap:10,alignItems:'center'}}><span style={{fontSize:'calc(var(--fs)*.65)',fontWeight:700,letterSpacing:'.12em',textTransform:'uppercase',color:'var(--text-secondary)',background:'var(--glass)',padding:'6px 16px',borderRadius:6}}>Humanitarian Corridor Map</span>{(ae?.incidents||[]).filter(i=>i.s==='critical').length>0&&<span style={{fontSize:'calc(var(--fs)*.6)',color:'var(--danger)',background:'var(--danger-bg)',padding:'4px 12px',borderRadius:6,fontWeight:700,letterSpacing:'.06em'}}>{(ae.incidents||[]).filter(i=>i.s==='critical').length} Critical</span>}</div>
{mapClickMode&&<div style={{position:'absolute',top:14,right:14,zIndex:1000,background:'var(--accent)',color:'#FFF',padding:'6px 14px',borderRadius:8,fontWeight:700,animation:'pulse 1.5s infinite'}}>{_('clickMap')}</div>}
{!mapClickMode&&<div style={{position:'absolute',top:14,right:14,zIndex:999,display:'flex',gap:5,flexDirection:'column'}}><button onClick={()=>{setShowIncForm(true);setDetailOpen(true);setDetailTab('incidents')}} style={{width:36,height:36,borderRadius:8,border:'1px solid var(--border-primary)',background:'var(--glass-strong)',cursor:'pointer',fontSize:'calc(var(--fs)*1)'}}>âš ï¸</button><button onClick={()=>window.print()} style={{width:36,height:36,borderRadius:8,border:'1px solid var(--border-primary)',background:'var(--glass-strong)',cursor:'pointer',fontSize:'calc(var(--fs)*1)'}}>ğŸ–¨ï¸</button></div>}
{sInc.length>0&&<div style={{position:'absolute',bottom:16,left:'50%',transform:'translateX(-50%)',zIndex:1000,display:'flex',gap:8,background:'var(--glass-strong)',border:'1px solid var(--border-primary)',borderRadius:12,padding:'10px 18px',alignItems:'center',boxShadow:'var(--shadow-md)'}}><span style={{fontSize:'calc(var(--fs)*.72)',color:'var(--text-muted)',fontWeight:700,marginRight:6}}>{_('timeline')}</span>{sInc.map(inc=><div key={inc.id} title={inc.ti} onClick={()=>flyTo(inc.a,inc.o)} style={{display:'flex',flexDirection:'column',alignItems:'center',cursor:'pointer',padding:'4px 8px',borderRadius:8}} onMouseEnter={e=>e.currentTarget.style.background='var(--bg-hover)'} onMouseLeave={e=>e.currentTarget.style.background='transparent'}><span style={{fontSize:'calc(var(--fs)*1.3)'}}>{ICON_MAP[inc.tp]||'âš ï¸'}</span><span style={{fontSize:'calc(var(--fs)*.62)',color:(SEVERITY[inc.s]||SEVERITY.medium).color,marginTop:3,fontWeight:700}}>{inc.dt.slice(5)}</span></div>)}</div>}
</>}
</div>
{detailOpen&&ae&&<div style={{width:420,minWidth:420,display:'flex',flexDirection:'column',background:'var(--bg-secondary)',borderLeft:'1px solid var(--border-primary)',zIndex:100,overflow:'hidden'}}>
<div style={{padding:'12px 14px',borderBottom:'1px solid var(--border-subtle)',display:'flex',alignItems:'flex-start',gap:8}}><div style={{flex:1}}><div style={{display:'flex',alignItems:'center',gap:5,marginBottom:3}}><span style={svB(ae.severity)}>{ae.severity?.toUpperCase()}</span><span style={{fontSize:'calc(var(--fs)*.5)',color:'var(--text-faint)'}}>{ae.status}</span></div><b style={{fontSize:'calc(var(--fs)*.88)',display:'block',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}}>{ae.name}</b></div><div style={{display:'flex',gap:4,flexShrink:0}}><button onClick={genShare} style={{background:'none',border:'1px solid var(--border-primary)',cursor:'pointer',color:'var(--text-muted)',padding:'4px 8px',borderRadius:5,fontSize:'calc(var(--fs)*.72)'}}>ğŸ”—</button><div style={{position:'relative'}}><button onClick={()=>setShowExportMenu(v=>!v)} style={{background:'none',border:'1px solid var(--border-primary)',cursor:'pointer',color:'var(--text-muted)',padding:'4px 8px',borderRadius:5,fontSize:'calc(var(--fs)*.72)'}}>ğŸ“¥</button>{showExportMenu&&<div style={{position:'absolute',top:'100%',right:0,marginTop:4,background:'var(--bg-secondary)',border:'1px solid var(--border-primary)',borderRadius:8,boxShadow:'var(--shadow-md)',zIndex:10,minWidth:150,overflow:'hidden'}}>{[{fn:()=>{dlF(JSON.stringify(eventToGeoJSON(ae),null,2),ae.name.replace(/\s+/g,'_')+'.geojson','application/geo+json');setShowExportMenu(false)},l:'ğŸ—ºï¸ GeoJSON'},{fn:()=>{dlF(eventToCSV(ae),ae.name.replace(/\s+/g,'_')+'.csv','text/csv');setShowExportMenu(false)},l:'ğŸ“Š CSV'},{fn:()=>{dlF(eventToReport(ae),ae.name.replace(/\s+/g,'_')+'.md');setShowExportMenu(false)},l:'ğŸ“ Report'}].map(x=><button key={x.l} onClick={x.fn} style={{display:'block',width:'100%',padding:'8px 14px',border:'none',background:'transparent',cursor:'pointer',fontSize:'calc(var(--fs)*.68)',color:'var(--text-secondary)',fontFamily:'inherit',textAlign:'left'}} onMouseEnter={e=>e.currentTarget.style.background='var(--bg-hover)'} onMouseLeave={e=>e.currentTarget.style.background='transparent'}>{x.l}</button>)}</div>}</div><button onClick={()=>setDetailOpen(false)} style={{background:'none',border:'none',cursor:'pointer',color:'var(--text-muted)',fontSize:'calc(var(--fs)*1.1)'}}>âœ•</button></div></div>
{ae.brief&&detailTab!=='overview'&&<div style={{padding:'6px 14px',borderBottom:'1px solid var(--border-subtle)',fontSize:'calc(var(--fs)*.62)',color:'var(--text-muted)',lineHeight:1.5,cursor:'pointer',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}} onClick={()=>setDetailTab('overview')} title={ae.brief}>ğŸ“‹ {ae.brief.slice(0,60)}â€¦</div>}
<div style={{display:'flex',borderBottom:'1px solid var(--border-subtle)',padding:'0 4px'}}>{[{id:'ai',i:'ğŸ¤–'},{id:'overview',i:'ğŸ“‹ Briefs'},{id:'incidents',i:'âš ï¸'},{id:'notebook',i:'ğŸ““'}].map(tb=><button key={tb.id} onClick={()=>setDetailTab(tb.id)} style={{flex:1,padding:'8px 2px',border:'none',background:'transparent',cursor:'pointer',fontSize:'calc(var(--fs)*.68)',fontFamily:'inherit',color:detailTab===tb.id?'var(--accent)':'var(--text-faint)',borderBottom:detailTab===tb.id?'2px solid var(--accent)':'2px solid transparent'}}>{tb.i}</button>)}</div>
<div style={{flex:1,overflowY:'auto',padding:'12px 14px',display:'flex',flexDirection:'column'}}>
{detailTab==='ai'&&<><div style={{flex:1,overflowY:'auto',display:'flex',flexDirection:'column',gap:6,marginBottom:8}}>{cMsgs.map((m,i)=><div key={i} style={{animation:'fadeIn .3s ease',maxWidth:'94%',alignSelf:m.role==='u'?'flex-end':'flex-start'}}>{m.role==='a'&&<div style={{fontSize:'calc(var(--fs)*.5)',color:'var(--text-faint)',marginBottom:2}}>ğŸ¤–</div>}<div style={{padding:'8px 10px',borderRadius:9,fontSize:'calc(var(--fs)*.75)',lineHeight:1.7,whiteSpace:'pre-wrap',wordBreak:'break-word',...(m.role==='u'?{background:'var(--surface-msg-user)',color:'var(--surface-msg-user-text)',borderBottomRightRadius:3}:{background:'var(--surface-msg-ai)',border:'1px solid var(--surface-msg-ai-border)',color:'var(--surface-msg-ai-text)',borderBottomLeftRadius:3})}}>{m.text}</div></div>)}{busy&&<div style={{alignSelf:'flex-start'}}><div style={{padding:'8px 10px',borderRadius:9,background:'var(--surface-msg-ai)',border:'1px solid var(--surface-msg-ai-border)'}}><span style={{animation:'blink 1.2s infinite',color:'var(--text-muted)'}}>{_('thinking')}</span></div></div>}<div ref={ceR}/></div><div style={{marginBottom:6}}><textarea value={briefInput} onChange={e=>setBriefInput(e.target.value)} placeholder={_('uploadBrief')} style={{...inp,minHeight:50,resize:'vertical',lineHeight:1.5}}/><div style={{display:'flex',gap:4,marginTop:4}}><button onClick={addBrief} disabled={!briefInput.trim()} style={{flex:1,padding:'6px 0',borderRadius:6,border:'none',background:'var(--accent)',color:'#FFF',cursor:briefInput.trim()?'pointer':'not-allowed',fontFamily:'inherit',fontSize:'calc(var(--fs)*.65)',fontWeight:600,opacity:briefInput.trim()?1:.5}}>{_('addBrief')}</button><button onClick={()=>analyzeBrief()} disabled={briefAnalyzing} style={{flex:1,padding:'6px 0',borderRadius:6,border:'1px solid var(--accent)',background:'transparent',color:'var(--accent)',cursor:!briefAnalyzing?'pointer':'not-allowed',fontFamily:'inherit',fontSize:'calc(var(--fs)*.65)',fontWeight:600,opacity:briefAnalyzing?.4:1}}>{briefAnalyzing?_('analyzing'):_('analyzeMap')}</button></div></div><div style={{display:'flex',gap:5}}><input value={inputVal} onChange={e=>setInputVal(e.target.value)} onKeyDown={e=>e.key==='Enter'&&!e.shiftKey&&sendMsg()} placeholder={apiKey?'Ask about this crisis...':_('notConfigured')} disabled={busy} style={{...inp,flex:1}}/><button onClick={sendMsg} disabled={busy} style={{padding:'8px 12px',borderRadius:7,border:'none',background:busy?'var(--text-faint)':'var(--text-primary)',color:'var(--bg-secondary)',cursor:busy?'not-allowed':'pointer',fontWeight:700}}>â†µ</button></div></>}
{detailTab==='overview'&&<><div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:4,marginBottom:12}}>{stats.map(s=><div key={s.label} style={{padding:'6px 2px',borderRadius:5,textAlign:'center',background:'var(--surface-card)',border:'1px solid var(--border-primary)'}}><div style={{fontSize:'calc(var(--fs)*1)',fontWeight:700,color:s.color}}>{s.value}</div><div style={{fontSize:'calc(var(--fs)*.45)',color:'var(--text-muted)'}}>{s.label}</div></div>)}</div>
{/* Main Brief */}
<div style={{marginBottom:12}}><div style={{fontSize:'calc(var(--fs)*.62)',fontWeight:700,color:'var(--text-muted)',marginBottom:4,textTransform:'uppercase'}}>ğŸ“Œ Main Brief</div>{ae.brief?<div style={{padding:'10px 12px',borderRadius:7,background:'var(--surface-card)',border:'1px solid var(--border-primary)',fontSize:'calc(var(--fs)*.72)',lineHeight:1.7,color:'var(--text-secondary)'}}>{ae.brief}</div>:<div style={{padding:'8px 12px',borderRadius:7,border:'1px dashed var(--border-primary)',color:'var(--text-faint)',fontSize:'calc(var(--fs)*.68)',textAlign:'center'}}>No main brief yet. Add one below or paste in AI tab.</div>}</div>
{/* Brief input area */}
<div style={{marginBottom:12}}><textarea value={briefInput} onChange={e=>setBriefInput(e.target.value)} placeholder={_('uploadBrief')} style={{...inp,minHeight:50,resize:'vertical',lineHeight:1.5,marginBottom:4}}/><div style={{display:'flex',gap:4}}><button onClick={addBrief} disabled={!briefInput.trim()} style={{flex:1,padding:'6px 0',borderRadius:6,border:'none',background:'var(--accent)',color:'#FFF',cursor:briefInput.trim()?'pointer':'not-allowed',fontFamily:'inherit',fontSize:'calc(var(--fs)*.62)',fontWeight:600,opacity:briefInput.trim()?1:.5}}>{_('addBrief')}</button><button onClick={()=>analyzeBrief()} disabled={briefAnalyzing} style={{flex:1,padding:'6px 0',borderRadius:6,border:'1px solid var(--accent)',background:'transparent',color:'var(--accent)',cursor:!briefAnalyzing?'pointer':'not-allowed',fontFamily:'inherit',fontSize:'calc(var(--fs)*.62)',fontWeight:600}}>{briefAnalyzing?_('analyzing'):_('analyzeMap')}</button></div></div>
{/* Additional Briefs */}
<div style={{marginBottom:12}}><div style={{fontSize:'calc(var(--fs)*.62)',fontWeight:700,color:'var(--text-muted)',marginBottom:4,textTransform:'uppercase'}}>{_('briefs')} ({aBriefs.length})</div>{aBriefs.length===0&&<div style={{fontSize:'calc(var(--fs)*.68)',color:'var(--text-faint)',padding:'8px 0'}}>{_('noBriefs')}</div>}{aBriefs.map(b=><div key={b.id} style={{padding:'8px 10px',borderRadius:6,marginBottom:4,background:'var(--surface-card)',border:'1px solid var(--border-primary)',fontSize:'calc(var(--fs)*.72)',lineHeight:1.6}}><div style={{display:'flex',justifyContent:'space-between',marginBottom:3}}><span style={{fontSize:'calc(var(--fs)*.5)',color:'var(--text-faint)'}}>{new Date(b.ts).toLocaleDateString()}</span><div style={{display:'flex',gap:6}}><button onClick={()=>{setEditBriefId(b.id);setEditBriefText(b.text)}} style={{fontSize:'calc(var(--fs)*.5)',color:'var(--accent)',background:'none',border:'none',cursor:'pointer'}}>{_('edit')}</button><button onClick={()=>archBrief(b.id)} style={{fontSize:'calc(var(--fs)*.5)',color:'var(--text-faint)',background:'none',border:'none',cursor:'pointer'}}>{_('archive')}</button><button onClick={()=>analyzeBrief(b.text)} style={{fontSize:'calc(var(--fs)*.5)',color:'var(--accent)',background:'none',border:'none',cursor:'pointer'}}>{_('analyzeMap')}</button></div></div>{editBriefId===b.id?<div><textarea value={editBriefText} onChange={e=>setEditBriefText(e.target.value)} style={{...inp,minHeight:60,resize:'vertical',marginBottom:4}}/><div style={{display:'flex',gap:4}}><button onClick={()=>saveBriefEdit(b.id)} style={{padding:'4px 10px',borderRadius:5,border:'none',background:'var(--accent)',color:'#FFF',cursor:'pointer',fontSize:'calc(var(--fs)*.6)',fontFamily:'inherit'}}>{_('save')}</button><button onClick={()=>setEditBriefId(null)} style={{padding:'4px 10px',borderRadius:5,border:'1px solid var(--border-primary)',background:'transparent',color:'var(--text-muted)',cursor:'pointer',fontSize:'calc(var(--fs)*.6)',fontFamily:'inherit'}}>{_('cancel')}</button></div></div>:<div style={{color:'var(--text-secondary)'}}>{b.text}</div>}</div>)}</div>{xBriefs.length>0&&<div style={{marginBottom:12}}><button onClick={()=>setShowArchived(v=>!v)} style={{fontSize:'calc(var(--fs)*.58)',color:'var(--text-faint)',background:'none',border:'none',cursor:'pointer'}}>{showArchived?'â–¾':'â–¸'} {_('archived')} ({xBriefs.length})</button>{showArchived&&xBriefs.map(b=><div key={b.id} style={{padding:'6px 10px',borderRadius:5,marginTop:3,background:'var(--bg-hover)',borderLeft:'3px solid var(--text-faint)',fontSize:'calc(var(--fs)*.65)',opacity:.7}}><div style={{fontSize:'calc(var(--fs)*.48)',color:'var(--text-faint)'}}>{new Date(b.ts).toLocaleDateString()}</div>{b.text}</div>)}</div>}{events.length>1&&<button onClick={()=>{if(confirm('Delete?'))delEv(ae.id)}} style={{marginTop:'auto',padding:'7px 0',borderRadius:7,border:'1px solid var(--danger)',background:'transparent',color:'var(--danger)',cursor:'pointer',fontFamily:'inherit',fontSize:'calc(var(--fs)*.65)',fontWeight:600,width:'100%'}}>ğŸ—‘ï¸ {_('deleteEvent')}</button>}</>}
{detailTab==='incidents'&&<>{showIncForm&&<div style={{padding:12,borderRadius:8,border:'1px solid var(--accent)',background:'var(--accent-bg)',marginBottom:10,animation:'fadeIn .2s ease'}}><div style={{fontSize:'calc(var(--fs)*.72)',fontWeight:700,marginBottom:8}}>{_('reportIncident')}</div><input value={incForm.ti} onChange={e=>setIncForm(p=>({...p,ti:e.target.value}))} placeholder={_('incTitle')} style={{...inp,marginBottom:5}}/><input value={incForm.d} onChange={e=>setIncForm(p=>({...p,d:e.target.value}))} placeholder={_('incDesc')} style={{...inp,marginBottom:5}}/><div style={{display:'flex',gap:5,marginBottom:5}}><select value={incForm.tp} onChange={e=>setIncForm(p=>({...p,tp:e.target.value}))} style={{...inp,flex:1}}>{INC_TYPES.map(tp=><option key={tp} value={tp}>{ICON_MAP[tp]||'âš ï¸'} {tp}</option>)}</select><select value={incForm.s} onChange={e=>setIncForm(p=>({...p,s:e.target.value}))} style={{...inp,flex:1}}>{SEV_LEVELS.map(s=><option key={s} value={s}>{s.toUpperCase()}</option>)}</select></div><div style={{display:'flex',gap:5,marginBottom:5}}><input value={incForm.ac} onChange={e=>setIncForm(p=>({...p,ac:e.target.value}))} placeholder="Actor" style={{...inp,flex:1}}/><input value={incForm.og} onChange={e=>setIncForm(p=>({...p,og:e.target.value}))} placeholder="Organization" style={{...inp,flex:1}}/></div><button onClick={()=>setMapClickMode(true)} style={{width:'100%',padding:'7px 0',borderRadius:6,border:'1px dashed var(--accent)',background:'transparent',color:'var(--accent)',cursor:'pointer',fontFamily:'inherit',fontSize:'calc(var(--fs)*.68)',fontWeight:600,marginBottom:5}}>{incForm.a!==null?`ğŸ“ ${incForm.a}, ${incForm.o}`:_('clickMap')}</button><label style={{display:'flex',alignItems:'center',gap:6,fontSize:'calc(var(--fs)*.65)',cursor:'pointer',marginBottom:5}}><input type="checkbox" checked={incForm.drawType==='circle'} onChange={e=>setIncForm(p=>({...p,drawType:e.target.checked?'circle':null}))} style={{accentColor:'var(--accent)'}}/>{_('drawCircle')}</label>{incForm.drawType==='circle'&&<div style={{display:'flex',alignItems:'center',gap:6,marginBottom:5}}><span style={{fontSize:'calc(var(--fs)*.62)'}}>{_('drawRadius')}</span><input type="range" min="10" max="200" value={incForm.drawR} onChange={e=>setIncForm(p=>({...p,drawR:+e.target.value}))} style={{flex:1,accentColor:'var(--accent)'}}/><span style={{fontSize:'calc(var(--fs)*.62)',color:'var(--text-muted)',minWidth:35}}>{incForm.drawR}km</span></div>}<div style={{display:'flex',gap:5}}><button onClick={subInc} disabled={!incForm.ti||incForm.a===null} style={{flex:1,padding:'7px 0',borderRadius:6,border:'none',background:'var(--accent)',color:'#FFF',cursor:incForm.ti&&incForm.a!==null?'pointer':'not-allowed',fontFamily:'inherit',fontSize:'calc(var(--fs)*.68)',fontWeight:600,opacity:incForm.ti&&incForm.a!==null?1:.5}}>{_('addIncident')}</button><button onClick={()=>setShowIncForm(false)} style={{flex:1,padding:'7px 0',borderRadius:6,border:'1px solid var(--border-primary)',background:'transparent',color:'var(--text-muted)',cursor:'pointer',fontFamily:'inherit',fontSize:'calc(var(--fs)*.68)'}}>{_('cancel')}</button></div></div>}{!showIncForm&&<button onClick={()=>setShowIncForm(true)} style={{padding:'8px 0',borderRadius:7,border:'1px dashed var(--accent)',background:'transparent',color:'var(--accent)',cursor:'pointer',fontFamily:'inherit',fontSize:'calc(var(--fs)*.68)',fontWeight:600,marginBottom:8,width:'100%'}}>+ {_('reportIncident')}</button>}{sInc.length===0&&<div style={{textAlign:'center',padding:16,color:'var(--text-faint)'}}>{_('noIncidents')}</div>}{sInc.map(inc=>{const sv=SEVERITY[inc.s]||SEVERITY.medium;const isEdit=editIncId===inc.id&&editInc;return<div key={inc.id} data-inc-id={inc.id} style={{padding:'8px 10px',borderRadius:7,marginBottom:4,border:'1px solid '+(isEdit?'var(--accent)':'var(--border-primary)'),background:isEdit?'var(--accent-bg)':'var(--surface-card)',animation:isEdit?'fadeIn .2s ease':'none'}}>{isEdit?<div><input value={editInc.ti} onChange={e=>setEditInc(p=>({...p,ti:e.target.value}))} style={{...inp,marginBottom:4,fontWeight:600}}/><input value={editInc.d} onChange={e=>setEditInc(p=>({...p,d:e.target.value}))} style={{...inp,marginBottom:4}}/><div style={{display:'flex',gap:4,marginBottom:4}}><select value={editInc.tp} onChange={e=>setEditInc(p=>({...p,tp:e.target.value}))} style={{...inp,flex:1}}>{INC_TYPES.map(tp=><option key={tp} value={tp}>{ICON_MAP[tp]||'âš ï¸'} {tp}</option>)}</select><select value={editInc.s} onChange={e=>setEditInc(p=>({...p,s:e.target.value}))} style={{...inp,flex:1}}>{SEV_LEVELS.map(s=><option key={s} value={s}>{s.toUpperCase()}</option>)}</select></div><div style={{display:'flex',gap:4,marginBottom:4}}><input value={editInc.ac} onChange={e=>setEditInc(p=>({...p,ac:e.target.value}))} placeholder="Actor" style={{...inp,flex:1}}/><input value={editInc.og} onChange={e=>setEditInc(p=>({...p,og:e.target.value}))} placeholder="Org" style={{...inp,flex:1}}/></div><div style={{display:'flex',gap:4}}><button onClick={saveEditInc} style={{flex:1,padding:'5px 0',borderRadius:5,border:'none',background:'var(--accent)',color:'#FFF',cursor:'pointer',fontSize:'calc(var(--fs)*.62)',fontFamily:'inherit',fontWeight:600}}>{_('save')}</button><button onClick={()=>deleteInc(inc.id)} style={{padding:'5px 8px',borderRadius:5,border:'1px solid var(--danger)',background:'transparent',color:'var(--danger)',cursor:'pointer',fontSize:'calc(var(--fs)*.62)',fontFamily:'inherit'}}>ğŸ—‘ï¸</button><button onClick={()=>{setEditIncId(null);setEditInc(null)}} style={{flex:1,padding:'5px 0',borderRadius:5,border:'1px solid var(--border-primary)',background:'transparent',color:'var(--text-muted)',cursor:'pointer',fontSize:'calc(var(--fs)*.62)',fontFamily:'inherit'}}>{_('cancel')}</button></div></div>:<div><div style={{display:'flex',alignItems:'center',gap:6}}><span onClick={()=>flyTo(inc.a,inc.o)} style={{cursor:'pointer'}}>{ICON_MAP[inc.tp]||'âš ï¸'}</span><b onClick={()=>flyTo(inc.a,inc.o)} style={{flex:1,fontSize:'calc(var(--fs)*.72)',cursor:'pointer'}}>{inc.ti}</b><span style={svB(inc.s)}>{inc.s.toUpperCase()}</span><button onClick={()=>startEditInc(inc)} style={{fontSize:'calc(var(--fs)*.5)',color:'var(--accent)',background:'none',border:'none',cursor:'pointer',padding:'2px 4px'}}>âœï¸</button></div><div style={{fontSize:'calc(var(--fs)*.62)',color:'var(--text-muted)',marginTop:3,paddingLeft:24}}>{inc.d}</div><div style={{fontSize:'calc(var(--fs)*.52)',color:'var(--text-faint)',marginTop:2,paddingLeft:24}}>{inc.dt} Â· {inc.ac} Â· {inc.og}</div></div>}</div>})}</>}
{detailTab==='notebook'&&<><div style={{flex:1,overflowY:'auto'}}>{(!ae.notebook||!ae.notebook.length)&&<div style={{textAlign:'center',padding:16,color:'var(--text-faint)'}}>{_('noNotes')}</div>}{(ae.notebook||[]).map(n=><div key={n.id} style={{padding:'8px 10px',borderRadius:7,marginBottom:4,background:'var(--surface-card)',border:'1px solid var(--border-primary)'}}><div style={{display:'flex',alignItems:'center',gap:6,marginBottom:3}}><span style={{fontSize:'calc(var(--fs)*.62)',fontWeight:700,color:'var(--accent)'}}>{n.author}</span><span style={{fontSize:'calc(var(--fs)*.48)',padding:'1px 4px',borderRadius:3,background:'var(--accent-bg)',color:'var(--accent)'}}>{n.type}</span><span style={{fontSize:'calc(var(--fs)*.48)',color:'var(--text-faint)',marginLeft:'auto'}}>{new Date(n.ts).toLocaleDateString()}</span></div><div style={{fontSize:'calc(var(--fs)*.72)',lineHeight:1.7,color:'var(--text-secondary)'}}>{noteText(n.text)}</div></div>)}</div><div style={{display:'flex',gap:5}}><input value={noteInput} onChange={e=>setNoteInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&addNote()} placeholder={_('addNote')} style={{...inp,flex:1}}/><button onClick={addNote} style={{padding:'8px 12px',borderRadius:7,border:'none',background:'var(--accent)',color:'#FFF',cursor:'pointer',fontWeight:700}}>+</button></div></>}
</div></div>}
{showShareModal&&<div style={{position:'fixed',inset:0,zIndex:9999,display:'flex',alignItems:'center',justifyContent:'center',background:'rgba(0,0,0,.5)'}} onClick={()=>setShowShareModal(false)}><div onClick={e=>e.stopPropagation()} style={{width:480,maxWidth:'90vw',background:'var(--bg-secondary)',border:'1px solid var(--border-primary)',borderRadius:14,padding:'20px 24px',boxShadow:'var(--shadow-lg)',animation:'fadeIn .2s ease'}}><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:14}}><b style={{fontSize:'calc(var(--fs)*.92)'}}>ğŸ”— {_('shareEvent')}</b><button onClick={()=>setShowShareModal(false)} style={{background:'none',border:'none',cursor:'pointer',color:'var(--text-muted)',fontSize:'calc(var(--fs)*1.1)'}}>âœ•</button></div><div style={{fontSize:'calc(var(--fs)*.72)',color:'var(--text-muted)',marginBottom:10}}>{_('shareDesc')}</div><label style={{display:'flex',alignItems:'center',gap:8,fontSize:'calc(var(--fs)*.68)',cursor:'pointer',marginBottom:10}}><div onClick={()=>setSharePwOn(v=>!v)} style={{width:36,height:20,borderRadius:10,background:sharePwOn?'var(--accent)':'var(--border-primary)',position:'relative',cursor:'pointer',transition:'background .2s'}}><div style={{width:16,height:16,borderRadius:8,background:'#FFF',position:'absolute',top:2,left:sharePwOn?18:2,transition:'left .2s'}}/></div>{_('pwProtect')} <span style={{color:'var(--text-faint)',fontSize:'calc(var(--fs)*.55)'}}>({_('optional')})</span></label>{sharePwOn&&<input type="text" value={sharePw} onChange={e=>setSharePw(e.target.value)} placeholder={_('password')} style={{...inp,marginBottom:10}}/>}<div style={{display:'flex',gap:6}}><input readOnly value={shareUrl} style={{...inp,flex:1,fontFamily:'monospace',fontSize:'calc(var(--fs)*.6)'}} onFocus={e=>e.target.select()}/><button onClick={cpShare} style={{padding:'8px 16px',borderRadius:7,border:'none',background:'var(--accent)',color:'#FFF',cursor:'pointer',fontWeight:700,whiteSpace:'nowrap'}}>{copyFb||_('copy')}</button></div></div></div>}
</div>)
}
